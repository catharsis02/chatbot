<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Bot</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    
    <style>{% raw %}
        :root{
            /* Higher-contrast palette for readability */
            --bg: #f5f7fb;
            --card: #ffffff;
            --muted: #475569; /* slate-600 */
            --accent: #1e40af; /* indigo-800 */
            --glass: rgba(2,6,23,0.03);
            --pill: #0b2540;
            --success: #059669; /* green-600 */
        }
        *{box-sizing:border-box}
        body{
            margin:0;padding:0;font-family: 'Roboto', Inter, system-ui, -apple-system, 'Segoe UI', Arial; background: linear-gradient(180deg,#f8fafc 0%, #f1f5f9 100%); color:#0b2036; font-size:16px; line-height:1.5;
        }
        h1{color:#0b2036;font-weight:600}
        /* Chat widget container */
        #chat-box{position:fixed; right:24px; bottom:24px; z-index:1200;}

        /* Floating toggle (pill) - fixed so it's always visible */
        #chat-toggle{
            position:fixed; right:20px; bottom:20px; display:inline-flex; gap:8px; align-items:center; border:none; background:var(--accent); color:white; padding:12px 18px; border-radius:24px; font-weight:700; box-shadow:0 10px 26px rgba(30,64,175,0.18); cursor:pointer; transition:transform .14s ease, box-shadow .14s ease; z-index:9999; font-size:15px;
        }
        #chat-toggle i{font-size:16px}
        #chat-toggle:active{transform:translateY(1px)}

        /* Chat panel */
    /* Slightly smaller chat panel for a less intrusive footprint */
    #chat-content{width:380px; height:520px; margin-top:12px; border-radius:14px; overflow:hidden; background:var(--card); color:#0b2036; box-shadow:0 14px 40px rgba(11,32,54,0.12); display:flex; flex-direction:column; transform-origin:100% 100%; opacity:0; transform:translateY(12px) scale(.98); pointer-events:none; transition:all .28s cubic-bezier(.2,.9,.2,1)}
        #chat-content.open{opacity:1; transform:translateY(0) scale(1); pointer-events:auto}

        #chat-header{padding:14px 16px; background:transparent; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #eef6ff}
        #chat-header .title{font-weight:700; color:#0b2036}
    #chat-messages{flex:1 1 auto; padding:18px; overflow:auto; background:linear-gradient(180deg,#fbfdff, #fbfdff)}

        /* Input area */
        #chat-input{display:flex; gap:8px; padding:12px; border-top:1px solid #eef6ff; align-items:center}
    #chat-input input{flex:1; padding:12px 14px; border-radius:999px; border:1px solid #cbd5e1; outline:none; transition:box-shadow .15s; font-size:15px; color:var(--pill); background:#fff}
    #chat-input input:focus{box-shadow:0 8px 24px rgba(30,64,175,0.08)}
    #chat-input button{background:var(--accent); color:white; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; transition:transform .14s}
        #chat-input button:active{transform:translateY(1px)}

        /* Message bubbles */
    .bubble{display:block; padding:12px 16px; margin:10px 0; border-radius:12px; max-width:82%; line-height:1.6; font-size:15px; box-shadow:0 6px 20px rgba(11,32,54,0.06); opacity:0; transform:translateY(6px); animation:popIn .28s forwards cubic-bezier(.2,.9,.2,1)}
    .sent{background:linear-gradient(90deg,var(--accent), #2563eb); color:white; align-self:flex-end; border-bottom-right-radius:6px}
    .received{background:#f8fafc; color:#0b2036; align-self:flex-start; border-bottom-left-radius:6px}

        @keyframes popIn{to{opacity:1; transform:none}}

        /* Typing indicator: three dots */
        .typing{display:inline-flex; gap:6px; align-items:center; margin:6px 0}
    .typing .dot{width:8px; height:8px; background:#a5b4fc; border-radius:50%; opacity:.95; transform:translateY(0); animation:typing 1s infinite}
        .typing .dot:nth-child(2){animation-delay:.12s}
        .typing .dot:nth-child(3){animation-delay:.24s}
        @keyframes typing{0%{transform:translateY(0); opacity:.6}50%{transform:translateY(-6px); opacity:1}100%{transform:translateY(0); opacity:.6}}

        /* Map modal with backdrop */
    #map-modal{display:none; position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:1400}
        #map-modal .backdrop{position:absolute; inset:0; background:rgba(6,18,34,0.46); backdrop-filter:blur(6px); opacity:0; transition:opacity .22s}
        #map-modal.show .backdrop{opacity:1}
        #map-modal > .sheet{position:relative; width:84%; height:78%; background:linear-gradient(180deg,#ffffff,#fbfdff); border-radius:12px; box-shadow:0 30px 80px rgba(11,32,54,0.22); transform:translateY(8px) scale(.98); opacity:0; transition:all .28s cubic-bezier(.2,.9,.2,1)}
        #map-modal.show > .sheet{transform:none; opacity:1}

    /* Ensure the map container always has a visible height when modal opens and fills sheet */
    #map { flex:1; height:100%; width:100%; min-height:360px; }

        /* small helpers */
    .meta{font-size:13px; color:var(--muted)}
    .error{color:#b00020; font-size:14px}
        @media (max-width:520px){#chat-content{width:92vw; height:70vh}}
    {% endraw %}</style>
</head>
<body>
    <h1 style="text-align: center; margin-top: 200px">Intelligent Web Chatbot</h1>
    <div id="chat-box">
        <button id="chat-toggle"><i class="fas fa-comments"></i><span style="margin-left:6px;">Chat</span></button>
        <div id="chat-content">
            <div id="chat-header">
                <div style="display:flex; align-items:center; gap:8px;">
                    <div style="font-weight:700;">Disaster Preparedness Assistant</div>
                </div>
                <div>
                    <button id="chat-close" style="background:transparent; border:none; font-size:18px; cursor:pointer;">‚úñ</button>
                </div>
            </div>
            <div style="padding:8px 14px; border-bottom:1px solid #eef6ff; background:transparent;">
                <button id="updates-button" style="background:transparent; border:1px solid #e6eef8; color:#0b2036; font-size:14px; cursor:pointer; padding:6px 10px; border-radius:8px;">Get latest updates</button>
            </div>
            <div id="chat-messages" aria-live="polite"></div>
            <div id="chat-input">
                <input type="text" id="user-input" placeholder="Type your message...">
                <button id="send-button">Send</button>
                <button id="location-button" title="Share my location" style="margin-left:8px;">üìç</button>
            </div>
        </div>
    </div>
    <!-- Map modal/container -->
    <div id="map-modal" style="display:none; position:fixed; inset:0; z-index:2000;">
        <div class="backdrop"></div>
        <div class="sheet">
            <div style="background:transparent; padding:8px; display:flex; align-items:center; justify-content:space-between; gap:12px;">
                <div style="font-weight:600">Your Location</div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <label style="font-size:13px;">Radius(km): <input id="ctrl-radius" type="number" value="20" style="width:80px; padding:4px; border:1px solid #e6eef8; border-radius:4px;"></label>
                    <label style="font-size:13px;">Days: <input id="ctrl-days" type="number" value="180" style="width:60px; padding:4px; border:1px solid #e6eef8; border-radius:4px;"></label>
                    <label style="font-size:13px;">Country: <input id="ctrl-country" type="text" value="India" style="width:120px; padding:4px; border:1px solid #e6eef8; border-radius:4px;"></label>
                    <label style="font-size:13px;">POI: <select id="poi-kind" style="padding:6px; border:1px solid #e6eef8; border-radius:6px;">
                        <option value="hospital">Hospitals</option>
                        <option value="pharmacy">Pharmacies</option>
                        <option value="school">Schools</option>
                        <option value="fuel">Fuel / Petrol</option>
                        <option value="police">Police</option>
                        <option value="fire_station">Fire stations</option>
                        <option value="amenity">All amenities</option>
                    </select></label>
                    <button id="pois-button" style="margin-right:8px;">Show POIs</button>
                    <button id="disasters-button" style="margin-right:8px;">Show nearby disasters</button>
                    <button id="close-map" style="border:none; background:transparent; font-size:18px; cursor:pointer;">‚úñ</button>
                </div>
            </div>
            <div style="display:flex; width:100%; height:calc(100% - 56px);">
                        <div id="map-side" style="flex:1; padding:12px; overflow:auto; background:#fff;">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                        <div style="font-weight:600">Nearby events</div>
                        <button id="map-locate" title="Center map on you" style="background:transparent; border:none; cursor:pointer;">üìç</button>
                    </div>
                    <div style="margin-bottom:8px; display:flex; gap:8px; align-items:center;">
                        <label style="font-size:13px;">Radius(km): <input id="side-radius" type="number" value="20" style="width:80px; padding:4px; border:1px solid #e6eef8; border-radius:4px;"></label>
                        <label style="font-size:13px;">Days: <input id="side-days" type="number" value="180" style="width:60px; padding:4px; border:1px solid #e6eef8; border-radius:4px;"></label>
                    </div>
                    <div id="map-spinner" style="display:none; text-align:center; padding:8px; color:#666">Loading‚Ä¶</div>
                    <div id="map-list"></div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>{% raw %}
        $(document).ready(function() {
            $('#chat-toggle').click(function() {
                var el = $('#chat-content');
                $('#chat-toggle').hide();
                el.show().addClass('open');
                setTimeout(function(){ $('#user-input').focus(); }, 300);
            });

            // close button inside chat
            $('#chat-close').click(function(){
                var el = $('#chat-content');
                el.removeClass('open');
                setTimeout(function(){ el.hide(); $('#chat-toggle').show(); }, 280);
            });

            $('#send-button').click(function() {
                sendMessage();
            });

            $('#user-input').keypress(function(e) {
                if(e.which == 13) {
                    sendMessage();
                }
            });

            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/\"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function appendBubble(text, kind) {
                var el = $('<div/>').addClass('bubble ' + kind).html(text);
                $('#chat-messages').append(el);
                $('#chat-messages').scrollTop($('#chat-messages')[0].scrollHeight);
            }

            function sendMessage() {
                var message = $('#user-input').val();
                if (message.trim() === '') return;

                appendBubble(escapeHtml(message), 'sent');
                $('#user-input').val('');

                // Show typing indicator
                var typingEl = $('<div/>').addClass('typing').attr('id', 'typing-indicator').text('Assistant is typing...');
                    // Show animated typing indicator
                    var typingEl = $('<div/>').addClass('typing').attr('id', 'typing-indicator');
                    typingEl.append($('<span/>').addClass('dot'));
                    typingEl.append($('<span/>').addClass('dot'));
                    typingEl.append($('<span/>').addClass('dot'));
                    $('#chat-messages').append(typingEl);
                $('#send-button').prop('disabled', true);

                $.ajax({
                    url: '/handle_message',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ message: message }),
                    success: function(data, textStatus, jqXHR) {
                        $('#typing-indicator').remove();
                        $('#send-button').prop('disabled', false);
                        // If server explicitly returned a fallback status, auto-fetch updates
                        if (jqXHR.status >= 400 || (data && data.response && (data.response.indexOf("couldn't access") !== -1 || data.response.indexOf('An error occurred') !== -1))) {
                            fetchUpdates('general');
                            return;
                        }
                        if (data && data.response) {
                            // Preserve newlines in responses
                            var formatted = escapeHtml(data.response).replace(/\n/g, '<br>');
                            appendBubble(formatted, 'received');
                        } else {
                            appendBubble('No reply from server.', 'received');
                        }
                    },
                    error: function(xhr, status, err) {
                        $('#typing-indicator').remove();
                        $('#send-button').prop('disabled', false);
                        // On error, automatically get latest updates
                        fetchUpdates('general');
                    }
                });
            }

            function fetchUpdates(tag) {
                $.ajax({
                    url: '/latest_updates',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ tag: tag }),
                    success: function(data) {
                        if (data && data.updates) {
                            var html = data.updates.map(function(t, i){ return (i+1)+'. '+escapeHtml(t); }).join('<br>');
                            appendBubble(html, 'received');
                        } else {
                            appendBubble('No updates available at the moment.', 'received');
                        }
                    },
                    error: function() {
                        appendBubble('<span class="error">Unable to fetch latest updates.</span>', 'received');
                    }
                });
            }

            // manual updates button
            $('#updates-button').click(function(e){
                e.stopPropagation();
                fetchUpdates('general');
            });

            // Location modal handling (text-only)
            function showLocationText(lat, lon, label) {
                var modal = $('#map-modal');
                modal.show().addClass('show');
                window._userLocation = {lat: parseFloat(lat), lon: parseFloat(lon), label: label || ''};
                // clear previous list
                $('#map-list').empty();
            }

            // Ensure we have a user location; try browser geolocation then server-side fallback
            function ensureLocation(cb) {
                if (window._userLocation) {
                    return cb(window._userLocation.lat, window._userLocation.lon, window._userLocation.label);
                }
                // try browser geolocation first
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(pos){
                        var lat = pos.coords.latitude, lon = pos.coords.longitude;
                        showLocationText(lat, lon, 'You are here');
                        return cb(lat, lon, 'You are here');
                    }, function(){
                        // fallback to server
                        fetch('/detect_location').then(function(r){ return r.json(); }).then(function(json){
                            if (json.location) {
                                showLocationText(json.location.lat, json.location.lon, json.location.display_name || 'Approximate location');
                                return cb(json.location.lat, json.location.lon, json.location.display_name || 'Approximate location');
                            }
                            appendBubble('<span class="error">Could not determine location.</span>', 'received');
                        }).catch(function(){ appendBubble('<span class="error">Could not determine location.</span>', 'received'); });
                    }, {timeout:5000});
                } else {
                    fetch('/detect_location').then(function(r){ return r.json(); }).then(function(json){
                        if (json.location) {
                            showLocationText(json.location.lat, json.location.lon, json.location.display_name || 'Approximate location');
                            return cb(json.location.lat, json.location.lon, json.location.display_name || 'Approximate location');
                        }
                        appendBubble('<span class="error">Could not determine location.</span>', 'received');
                    }).catch(function(){ appendBubble('<span class="error">Could not determine location.</span>', 'received'); });
                }
            }

            $('#location-button').click(function(){
                // Prefer browser geolocation
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(pos){
                        var lat = pos.coords.latitude;
                        var lon = pos.coords.longitude;
                        showLocationText(lat, lon, 'You are here');
                    }, function(err){
                        // Fallback to server-side IP detection
                        fetch('/detect_location').then(function(r){ return r.json(); }).then(function(json){
                            if (json.location) {
                                        showLocationText(json.location.lat, json.location.lon, json.location.display_name || 'Approximate location');
                            } else {
                                appendBubble('<span class="error">Could not determine location.</span>', 'received');
                            }
                        }).catch(function(){
                            appendBubble('<span class="error">Could not determine location.</span>', 'received');
                        });
                    }, {timeout:5000});
                } else {
                    // no geolocation API
                    fetch('/detect_location').then(function(r){ return r.json(); }).then(function(json){
                        if (json.location) {
                            showLocationText(json.location.lat, json.location.lon, json.location.display_name || 'Approximate location');
                        } else {
                            appendBubble('<span class="error">Could not determine location.</span>', 'received');
                        }
                    }).catch(function(){
                        appendBubble('<span class="error">Could not determine location.</span>', 'received');
                    });
                }
            });

            $('#close-map').click(function(){
                $('#map-modal').removeClass('show');
                setTimeout(function(){ $('#map-modal').hide(); }, 260);
            });

            $('#disasters-button').click(function(){
                // Use ensureLocation to obtain coordinates if not yet available
                var fetchAndRender = function(lat, lon){
                    // helper to render disasters (text list)
                    function renderDisasters(json) {
                        if (!json || !json.disasters) {
                            appendBubble('No nearby disasters found.', 'received');
                            return;
                        }
                        var list = json.disasters;
                        if (!list.length) {
                            appendBubble('No nearby disasters found.', 'received');
                            return;
                        }
                        // render as text list
                        $('#map-modal').show().addClass('show');
                        $('#map-list').empty();
                        list.forEach(function(d){
                            var title = d.title || d.place || 'Event';
                            var el = $('<div>').css({padding:'8px', borderBottom:'1px solid #f0f4fb'});
                            var html = '<div style="font-weight:600">'+escapeHtml(title)+'</div>';
                            if (d.time) html += '<div class="meta">'+escapeHtml(d.time)+'</div>';
                            if (d.source) html += '<div class="meta">'+escapeHtml(d.source)+'</div>';
                            if (d.url) html += '<div style="margin-top:6px;"><a href="'+escapeHtml(d.url)+'" target="_blank">Source</a></div>';
                            if (d.lat && d.lon) html += '<div style="margin-top:6px; font-size:13px">Coords: <code>'+escapeHtml(String(d.lat))+', '+escapeHtml(String(d.lon))+'</code> <button class="copy-coords" data-lat="'+escapeHtml(String(d.lat))+'" data-lon="'+escapeHtml(String(d.lon))+'" style="margin-left:6px; padding:4px 6px; font-size:12px;">Copy coords</button></div>';
                            el.html(html);
                            $('#map-list').append(el);
                        });
                        // wire copy buttons
                        $('#map-list').off('click', '.copy-coords').on('click', '.copy-coords', function(e){
                            var lat = $(this).data('lat'); var lon = $(this).data('lon');
                            var txt = lat+','+lon;
                            if (navigator.clipboard && navigator.clipboard.writeText) {
                                navigator.clipboard.writeText(txt).then(function(){ alert('Coordinates copied to clipboard'); }).catch(function(){ alert('Could not copy'); });
                            } else {
                                var ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); alert('Coordinates copied to clipboard'); }catch(e){ alert('Could not copy'); } ta.remove();
                            }
                        });
                        appendBubble('Nearby disasters: see panel', 'received');
                    }

                    var r = parseInt($('#ctrl-radius').val()||20,10);
                    var d = parseInt($('#ctrl-days').val()||180,10);
                    var ctry = ($('#ctrl-country').val()||'India');
                    fetch('/nearby_disasters', {
                        method: 'POST', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({lat:lat, lon:lon, radius_km:r, days:d, country:ctry})
                    }).then(function(resp){ return resp.json(); }).then(function(json){ renderDisasters(json); }).catch(function(){ appendBubble('<span class="error">Failed to fetch nearby disasters.</span>', 'received'); });
                };

                if (!window._userLocation) {
                    // Ask for location and then fetch
                    ensureLocation(function(lat, lon, label){
                        fetchAndRender(lat, lon);
                    });
                } else {
                    fetchAndRender(window._userLocation.lat, window._userLocation.lon);
                }
            });

            // POI handling: call server /map_pois and render returned POIs
            $('#pois-button').click(function(){
                if (!window._userLocation) {
                    appendBubble('<span class="error">Please share your location first (click üìç).</span>', 'received');
                    return;
                }
                var lat = window._userLocation.lat; var lon = window._userLocation.lon;
                var r_km = parseInt($('#ctrl-radius').val()||20,10);
                var radius_m = Math.max(100, r_km * 1000);
                var kind = $('#poi-kind').val() || 'amenity';
                var limit = 50;
                $('#map-spinner').show();
                fetch('/map_pois', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({lat:lat, lon:lon, radius_m: radius_m, kind: kind, limit: limit})
                }).then(function(r){ return r.json(); }).then(function(json){
                    $('#map-spinner').hide();
                    renderPOIs(json);
                }).catch(function(err){
                    $('#map-spinner').hide();
                    appendBubble('<span class="error">Failed to fetch POIs.</span>', 'received');
                });
            });
            function renderPOIs(json) {
                if (!json || !json.pois) {
                    appendBubble('No POIs found nearby.', 'received');
                    return;
                }
                var list = json.pois;
                if (!list.length) {
                    appendBubble('No POIs found nearby.', 'received');
                    return;
                }
                $('#map-modal').show().addClass('show');
                $('#map-list').empty();
                list.forEach(function(p){
                    var name = p.name || (p.tags && (p.tags['name'] || p.tags['amenity'])) || 'POI';
                    var el = $('<div>').css({padding:'8px', borderBottom:'1px solid #f0f4fb'});
                    var html = '<div style="font-weight:600">'+escapeHtml(name)+'</div>';
                    if (p.tags && (p.tags['addr:full'] || p.tags['addr:street'])) html += '<div class="meta">'+escapeHtml(p.tags['addr:full'] || p.tags['addr:street'])+'</div>';
                    html += '<div class="meta">'+escapeHtml(p.osm_type || '')+'</div>';
                    if (p.tags && p.tags.website) html += '<div style="margin-top:6px"><a href="'+escapeHtml(p.tags.website)+'" target="_blank">Website</a></div>';
                    // link to OSM element
                    var osmLink = 'https://www.openstreetmap.org/' + (p.osm_type || 'node') + '/' + p.id;
                    html += '<div style="margin-top:6px"><a href="'+escapeHtml(osmLink)+'" target="_blank">OpenStreetMap</a></div>';
                    if (p.lat && p.lon) html += '<div style="margin-top:6px; font-size:13px">Coords: <code>'+escapeHtml(String(p.lat))+', '+escapeHtml(String(p.lon))+'</code> <button class="copy-coords" data-lat="'+escapeHtml(String(p.lat))+'" data-lon="'+escapeHtml(String(p.lon))+'" style="margin-left:6px; padding:4px 6px; font-size:12px;">Copy coords</button></div>';
                    el.html(html);
                    $('#map-list').append(el);
                });
                // wire copy buttons (already wired above but safe to ensure)
                $('#map-list').off('click', '.copy-coords').on('click', '.copy-coords', function(e){
                    var lat = $(this).data('lat'); var lon = $(this).data('lon');
                    var txt = lat+','+lon;
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(txt).then(function(){ alert('Coordinates copied to clipboard'); }).catch(function(){ alert('Could not copy'); });
                    } else {
                        var ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); alert('Coordinates copied to clipboard'); }catch(e){ alert('Could not copy'); } ta.remove();
                    }
                });
                appendBubble('POIs loaded: see panel', 'received');
            }

            $('#map-locate').click(function(){
                // prefer browser geolocation
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(pos){
                        var lat = pos.coords.latitude; var lon = pos.coords.longitude;
                        if (window._chatmap) { window._chatmap.setView([lat, lon], 8); }
                    }, function(){
                        fetch('/detect_location').then(function(r){ return r.json(); }).then(function(json){ if (json.location && window._chatmap) window._chatmap.setView([json.location.lat, json.location.lon], 8); });
                    }, {timeout:5000});
                } else {
                    fetch('/detect_location').then(function(r){ return r.json(); }).then(function(json){ if (json.location && window._chatmap) window._chatmap.setView([json.location.lat, json.location.lon], 8); });
                }
            });
        });
    {% endraw %}</script>
</body>
</html>